<form theme="dark">
  <label>ITSI KPI Analysis</label>
  <init>
    <set token="help_s1_overview">This section provides information regarding the health of the KPI within the framework of ITSI. Before KPI thresholding can be meaningfully performed it is important to ensure the KPI is consistently running and is generally healthy. If the panels in this section appear unhealthy or concerning, simply click the panel and be taken to the ITSI Health Check dashboard for further troubleshooting</set>
    <set token="help_s1_p1">5 minute KPIs should consistently produce 12 results per hour. 15 minutes KPIs should produce 4 results per hour. This graph shows the number of record written to the itsi_summary index per hour relative to the expected number of results. While some variance might occur, repeat and consistent deviations of actual vs. expected may indicate a resource limitation in Splunk where the KPI cannot consistently run. This will need to be investigated</set>
    <set token="help_s1_p2">TBD. Is this an important thing to track?</set>
    <set token="help_s2_overview">This section provides information regarding the severity values of the KPI as determined by the threshold values configured when the KPI ran and results were recorded to the itsi_summary index. This view provides an accurate historical record and view of how the KPI severity was rendered in the Service Analyzer and Deep Dive at that time. By contrast, retrospective review the KPI results in the Deep Dive will dynamically recompute and render severities based on the current threshold configurations. While this behavior is typically desirable, it means that there is no native view in ITSI where administrators can see the historically accurate KPI severity values. The panels in this section address this need</set>
    <set token="help_s2_p1">This panel provides the overall distribution of severity values for the KPI. Ensure that your KPI severities distribution meets your expectations based on the historical data. For instance, if you're looking at the KPI values for the last week, and the week was a 'normal' week, you would not expect to see a large percentage of high or critical values.</set>
    <set token="help_s2_p2">On this timechart, normal results for the KPI are plotted as a green line. Abnormal results are plotted in their respective color where they occur. The green normal line will be discontinuous in the presence of abnormal results. The height of the line corresponds to the alert value so it is easily to visualize when results, normal or otherwise, are incorrectly computed. Unknown results are plotted under the timechart in grey and should be investigated. Zero value results have no height and will not appear on the graph even if they are abnormal</set>
    <set token="help_s2_p3">This panel will allow you to see trends in how KPI severities align to specific days and specific hours within a day. The size of the circle for that hour is sized relative to all other values, larger circles indicate a higher concentration of selected severities compared with other hours and other days. To gain value from this panel, select a specific severity (for instance critical) and look to see if there exists a trend or concentration of these events in a particular hour of day or day of week. If the trend is unexpected it could indicate that thresholds for that trend need to be adjusted.</set>
    <set token="help_s3_overview">The panels in this section are identical to the section above with one major exception. Instead of rendering KPI severity values based on the historical results written to the itsi_summary index, these severities are dynamically computed based on the currently configured thresholds for the service. This section is intended to allow the ITSI service administrator to alter threshold configurations in the service and immediately see how the changes would impact the KPIs historical results. Use this sections capabilities to incrementally improve instances where the historical threshold did not compute as desired or expected</set>
    <set token="help_s4_overview">The panels in this section are identical to the section above with one major exception. This section contains an alert value multiplier which allows the ITSI service administrator to evaluate the performance of the current threshold configurations after the historical KPI values have been either increased or decreased by the alert value multiplier. For instance, specifying a multiplier of 0.5 will reduce all historical results by fifty percent and recompute the KPI severities based on these new KPI values and current threshold configurations. Similarly, specifying a multiplier of 2.0 would double historical KPI values. The ITSI service administrator can use this section gain confidence that the current threshold configurations adequately detect extreme increases and decreases in KPI values when the occur</set>
    <set token="help_s5_overview">The panels in this section help to visualize KPI values by hour of the day and day of week to find similar groups. The ITSI service administrator can use these panels to determine the most effective time policies to build within the service configuration.</set>
    <set token="help_s5_p1_p2">These panels compute and display the alert value mean and alert value standard deviation by hour of day and day of week. The size of the circle is relative to value for that hour as compared to all other values. Similar sized circles indicate hours where the KPI behaves similarly for that value. When using the standard deviation adaptive threshold policy, hours which share similar mean and standard deviation values should be grouped together in the same time policy</set>
    <set token="help_s5_p3">This panel uses a ML clustering algorithm to determine similar groups. This provides a suggested starting point for which hours and which days should be grouped together in a single time policy. You can increase or decrease the target number of time policies to have the algorithm group together more or fewer hours</set>
  </init>
  <search id="historical">
    <query>index=itsi_summary $kpiid$ | eval is_shs = if(LIKE(kpiid,"SH%"),1,0) | where is_shs=1 OR (is_service_aggregate=1 AND is_service_max_severity_event=0) | table *</query>
    <earliest>$field1.earliest$</earliest>
    <latest>$field1.latest$</latest>
    <sampleRatio>1</sampleRatio>
    <finalized>
      <condition match="'job.resultCount' != 0">
        <set token="kpiid_val">$result.kpiid$</set>
        <set token="serviceid_val">$result.serviceid$</set>
        <set token="hide_panel">1</set>
      </condition>
    </finalized>
  </search>
  <search base="historical">
    <query>| timechart count span=1h | sort - _time | streamstats count as inc | where inc!=1 | stats min(count) as min max(count) as max | eval min=min-1 | eval max=max+1</query>
    <finalized>
      <condition match="'job.resultCount' != 0">
        <set token="kpi_freq_min">$result.min$</set>
        <set token="kpi_freq_max">$result.max$</set>
      </condition>
    </finalized>
  </search>
  <search id="dynamic">
    <query>index=itsi_summary $kpiid$ is_service_max_severity_event=0  is_service_aggregate=1 alert_value=* alert_severity=* alert_level=* date_hour=* date_wday=* | `assess_severity($serviceid_val$, $kpiid_val$)` | table *</query>
    <earliest>$field1.earliest$</earliest>
    <latest>$field1.latest$</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  <search id="adjusted">
    <query>index=itsi_summary $kpiid$ is_service_max_severity_event=0  is_service_aggregate=1 alert_value=* alert_severity=* alert_level=* date_hour=* date_wday=*
| eval alert_value = alert_value * $av_multiplier$
| `assess_severity($serviceid_val$, $kpiid_val$)` | table *</query>
    <earliest>$field1.earliest$</earliest>
    <latest>$field1.latest$</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="field1">
      <label></label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="kpiid">
      <label>KPI</label>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>key</fieldForValue>
      <search>
        <query>| inputlookup service_kpi_lookup
| eval mvzip = mvzip('kpis._key', 'kpis.title')
| mvexpand mvzip
| eval mvzip = split(mvzip,",")
| eval key = mvindex(mvzip, 0)
| eval name = mvindex(mvzip,1)
| eval name = title."-".name</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <prefix>kpiid=</prefix>
    </input>
    <input type="dropdown" token="mode">
      <label>Dashboard Mode</label>
      <choice value="1">Simple</choice>
      <choice value="2">Intermediate</choice>
      <choice value="3">Advanced</choice>
      <default>1</default>
      <change>
        <condition value="1">
          <set token="mode_simple">true</set>
          <unset token="mode_intermediate"></unset>
          <unset token="mode_advanced"></unset>
        </condition>
        <condition value="2">
          <set token="mode_simple">true</set>
          <set token="mode_intermediate"></set>
          <unset token="mode_advanced"></unset>
        </condition>
        <condition value="3">
          <set token="mode_simple">true</set>
          <set token="mode_intermediate"></set>
          <set token="mode_advanced"></set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="help">
      <label>Show Help</label>
      <choice value="1">Yes</choice>
      <choice value="0">No</choice>
      <default>0</default>
      <change>
        <condition value="1">
          <set token="help">true</set>
        </condition>
        <condition value="0">
          <unset token="help"></unset>
        </condition>
      </change>
    </input>
  </fieldset>
  <row depends="$help$">
    <panel>
      <title></title>
      <html>
        <h1>Splunkbase Application Prerequisites</h1>
        <p>To function properly, please make sure the following apps have been installed in this environment</p>
        
        <p><b>Machine Learning Toolkit</b> - <a href="https://splunkbase.splunk.com/app/2890/">https://splunkbase.splunk.com/app/2890/</a></p>
        <p><b>Python for Scientific Computing</b> - <a href="https://splunkbase.splunk.com/apps/#/search/Python%20for%20Scientific%20Computing/">https://splunkbase.splunk.com/apps/#/search/Python%20for%20Scientific%20Computing/</a></p>
        <p><b>Punchcard Visualization</b> - <a href="https://splunkbase.splunk.com/app/3129/">https://splunkbase.splunk.com/app/3129/</a></p>
          
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h1>Overall KPI Health</h1>
      </html>
    </panel>
  </row>
  <row depends="$help$">
    <panel>
      <html>
        <b>Section Overview</b>
        <p>$help_s1_overview$</p>
        
        <p>
          <b>KPI Frequency Actual vs Expected</b> - $help_s1_p1$</p>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>KPI Frequency Actual vs Expected</title>
      <chart>
        <search base="historical">
          <query>| timechart count span=1h
| rename count as actual
| eval expected_1m=60
| eval expected_5m=12
| eval expected_15m=4</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisLabelsY.majorUnit">1</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.maximumNumber">$kpi_freq_max$</option>
        <option name="charting.axisY.minimumNumber">$kpi_freq_min$</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <drilldown>
          <link target="_blank">/app/itsi/itsi_healthcheck</link>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel depends="$bogus$">
      <title>KPI Result Timestamp Minute of Hour</title>
      <viz type="punchcard_app.punchcard">
        <search base="historical">
          <query>| eval stamp_min = strftime(_time, "%M")
| stats count by stamp_min
| makecontinuous stamp_min
| eval col="count"
| table stamp_min, col, count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h1>Historical KPI Results and Performance</h1>
      </html>
    </panel>
  </row>
  <row depends="$help$">
    <panel>
      <html>
        <b>Section Overview</b>
        <p>$help_s2_overview$</p>
        
        <p>
          <b>Distribution of KPI Severity</b> - $help_s2_p1$</p>
        <p>
          <b>KPI Severities over Time</b> - $help_s2_p2$</p>
        <p>
          <b>Distribution of KPI Severities by Hour of Day and Day of Week</b> - $help_s2_p3$</p>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Distribution of KPI Severity</title>
      <chart>
        <search base="historical">
          <query>| top alert_severity</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"normal":#99D18B, "critical":#B50101, "high":#F26A35, "medium":#FCB64E, "low":#FFE98C, "info":#AED3E5, "unknown":#A9A9A9}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>KPI Severities over Time</title>
      <chart>
        <search base="historical">
          <query>| eventstats perc50(alert_value) as p90_alert_value
| eval alert_value = if(alert_level&gt;0, alert_value, -1*p90_alert_value)
| bin _time span=1m@m
| chart max(alert_value) as alert_value over _time by alert_severity</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">normal</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"normal":#99D18B, "critical":#B50101, "high":#F26A35, "medium":#FCB64E, "low":#FFE98C, "info":#AED3E5, "unknown":#A9A9A9}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.data.count">500000</option>
        <option name="charting.chart.resultTruncationLimit">500000</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Distribution of KPI Severities by Hour of Day and Day of Week</title>
      <input type="multiselect" token="severity">
        <label>Severities</label>
        <choice value="2">Normal</choice>
        <choice value="1">Info</choice>
        <choice value="3">Low</choice>
        <choice value="4">Medium</choice>
        <choice value="5">High</choice>
        <choice value="6">Critical</choice>
        <choice value="-1">Unknown</choice>
        <prefix>alert_level IN (</prefix>
        <suffix>)</suffix>
        <initialValue>5,6</initialValue>
        <delimiter>,</delimiter>
      </input>
      <viz type="punchcard_app.punchcard">
        <search base="historical">
          <query>| eval is_abnormal = if(searchmatch("$severity$"),1,null())
| eval abnormal_level = if(is_abnormal=1, alert_level, 0)
| stats count(is_abnormal) as is_abnormal max(abnormal_level) as max_abnormal_level by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">sequential</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#dc4e41</option>
        <option name="punchcard_app.punchcard.minColor">#D3D3D3</option>
        <option name="punchcard_app.punchcard.numOfBins">9</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <html>
        <h1>Dynamically Computed KPI Results and Performance</h1>
      </html>
    </panel>
  </row>
  <row depends="$mode_intermediate$,$help$">
    <panel>
      <html>
        <b>Section Overview</b>
        <p>$help_s3_overview$</p>
      </html>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <title>Distribution of KPI Severity</title>
      <chart>
        <search base="dynamic">
          <query>| top alert_severity</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"normal":#99D18B, "critical":#B50101, "high":#F26A35, "medium":#FCB64E, "low":#FFE98C, "info":#AED3E5, "unknown":#A9A9A9}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <title>KPI Severities over Time</title>
      <chart>
        <search base="dynamic">
          <query>| eventstats perc50(alert_value) as p90_alert_value
| eval alert_value = if(alert_level&gt;0, alert_value, -1*p90_alert_value)
| bin _time span=1m@m
| chart max(alert_value) as alert_value over _time by alert_severity</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">normal</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"normal":#99D18B, "critical":#B50101, "high":#F26A35, "medium":#FCB64E, "low":#FFE98C, "info":#AED3E5, "unknown":#A9A9A9}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.data.count">500000</option>
        <option name="charting.chart.resultTruncationLimit">500000</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <title>Distribution of KPI Severities by Hour of Day and Day of Week</title>
      <input type="multiselect" token="dyn_severity">
        <label>Severities</label>
        <choice value="2">Normal</choice>
        <choice value="1">Info</choice>
        <choice value="3">Low</choice>
        <choice value="4">Medium</choice>
        <choice value="5">High</choice>
        <choice value="6">Critical</choice>
        <choice value="-1">Unknown</choice>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <initialValue>5,6</initialValue>
        <delimiter> OR </delimiter>
        <valuePrefix>alert_level=</valuePrefix>
      </input>
      <viz type="punchcard_app.punchcard">
        <search base="dynamic">
          <query>| eval is_abnormal = if($dyn_severity$,1,null())
| eval abnormal_level = if(is_abnormal=1, alert_level, 0)
| stats count(is_abnormal) as is_abnormal max(abnormal_level) as max_abnormal_level by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">sequential</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#dc4e41</option>
        <option name="punchcard_app.punchcard.minColor">#D3D3D3</option>
        <option name="punchcard_app.punchcard.numOfBins">9</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <html>
        <h1>Adjustable KPI Values Dynamically Computed KPI Results and Performance</h1>
      </html>
    </panel>
  </row>
  <row depends="$mode_intermediate$,$help$">
    <panel>
      <html>
        <b>Section Overview</b>
        <p>$help_s4_overview$</p>
      </html>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <input type="text" token="av_multiplier">
        <label>Alert Value Multiplier</label>
        <default>1.0</default>
      </input>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <title>Distribution of KPI Severity</title>
      <chart>
        <search base="adjusted">
          <query>| top alert_severity</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"normal":#99D18B, "critical":#B50101, "high":#F26A35, "medium":#FCB64E, "low":#FFE98C, "info":#AED3E5, "unknown":#A9A9A9}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <title>KPI Severities over Time</title>
      <chart>
        <search base="adjusted">
          <query>| eventstats perc50(alert_value) as p90_alert_value
| eval alert_value = if(alert_level&gt;0, alert_value, -1*p90_alert_value)
| bin _time span=1m@m
| chart max(alert_value) as alert_value over _time by alert_severity</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">normal</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"normal":#99D18B, "critical":#B50101, "high":#F26A35, "medium":#FCB64E, "low":#FFE98C, "info":#AED3E5, "unknown":#A9A9A9}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.data.count">500000</option>
        <option name="charting.chart.resultTruncationLimit">500000</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$mode_intermediate$">
    <panel>
      <title>Distribution of KPI Severities by Hour of Day and Day of Week</title>
      <input type="multiselect" token="adj_severity">
        <label>Severities</label>
        <choice value="2">Normal</choice>
        <choice value="1">Info</choice>
        <choice value="3">Low</choice>
        <choice value="4">Medium</choice>
        <choice value="5">High</choice>
        <choice value="6">Critical</choice>
        <choice value="-1">Unknown</choice>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <initialValue>5,6</initialValue>
        <delimiter> OR </delimiter>
        <valuePrefix>alert_level=</valuePrefix>
      </input>
      <viz type="punchcard_app.punchcard">
        <search base="adjusted">
          <query>| eval is_abnormal = if($adj_severity$,1,null())
| eval abnormal_level = if(is_abnormal=1, alert_level, 0)
| stats count(is_abnormal) as is_abnormal max(abnormal_level) as max_abnormal_level by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">sequential</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#dc4e41</option>
        <option name="punchcard_app.punchcard.minColor">#D3D3D3</option>
        <option name="punchcard_app.punchcard.numOfBins">9</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_advanced$">
    <panel>
      <html>
        <h1>Time Policy Suggestions and Guidance</h1>
      </html>
    </panel>
  </row>
  <row depends="$mode_advanced$,$help$">
    <panel>
      <html>
        <b>Section Overview</b>
        <p>$help_s5_overview$</p>
        <p>
          <b>KPI Mean &amp; Stdev Alert Value Distributions</b> - $help_s5_p1_p2$</p>
        <p>
          <b>Suggested Time Policy for Standard Deviation</b> - $help_s5_p3$</p>
      </html>
    </panel>
  </row>
  <row depends="$mode_advanced$">
    <panel>
      <title>KPI Mean Alert Value Distribution</title>
      <viz type="punchcard_app.punchcard">
        <search base="historical">
          <query>| stats mean(alert_value) by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">categorical</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#3fc77a</option>
        <option name="punchcard_app.punchcard.minColor">#d93f3c</option>
        <option name="punchcard_app.punchcard.numOfBins">6</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_advanced$">
    <panel>
      <title>KPI Stdev Alert Value Distribution</title>
      <viz type="punchcard_app.punchcard">
        <search base="historical">
          <query>| stats stdev(alert_value) by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">categorical</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#3fc77a</option>
        <option name="punchcard_app.punchcard.minColor">#d93f3c</option>
        <option name="punchcard_app.punchcard.numOfBins">6</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_advanced$,$num_clusters$">
    <panel>
      <title>Suggested Time Policy for Standard Deviation</title>
      <input type="text" token="num_clusters">
        <label>Target Number of Time Policies</label>
        <default>5</default>
      </input>
      <table>
        <search base="historical">
          <query>| stats stdev(alert_value) as a_value mean(alert_value) as b_value by date_hour date_wday 

| fit StandardScaler "a_value", "b_value" with_mean=true with_std=true
| fit KMeans k=$num_clusters$ "SS_a_value" "SS_b_value"

| eval date_hour=if(date_hour&lt;10,"0".date_hour, date_hour)
| eval date_wday=case(date_wday="monday",1,date_wday="tuesday",2,date_wday="wednesday",3,date_wday="thursday",4,date_wday="friday",5,date_wday="saturday",6,date_wday="sunday",7)."-".date_wday

| sort date_hour, date_wday

| eventstats count as policy_cnt by cluster
| eventstats max(policy_cnt) as max_policy
| eval policy = if(policy_cnt=max_policy, "", cluster)

| sort date_hour, date_wday

| fields - max_policy policy_cnt date policy_num

| chart limit=0 values(policy) over date_wday by date_hour</query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$mode_advanced$">
    <panel>
      <title>KPI Min Alert Value Distribution</title>
      <viz type="punchcard_app.punchcard">
        <search base="historical">
          <query>| stats min(alert_value) by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">categorical</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#3fc77a</option>
        <option name="punchcard_app.punchcard.minColor">#d93f3c</option>
        <option name="punchcard_app.punchcard.numOfBins">6</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_advanced$">
    <panel>
      <title>KPI Max Alert Value Distribution</title>
      <viz type="punchcard_app.punchcard">
        <search base="historical">
          <query>| stats max(alert_value) by date_hour date_wday</query>
        </search>
        <option name="drilldown">none</option>
        <option name="punchcard_app.punchcard.colorMode">categorical</option>
        <option name="punchcard_app.punchcard.labelRotation">horizontal</option>
        <option name="punchcard_app.punchcard.maxColor">#3fc77a</option>
        <option name="punchcard_app.punchcard.minColor">#d93f3c</option>
        <option name="punchcard_app.punchcard.numOfBins">6</option>
        <option name="punchcard_app.punchcard.radiusScale">global</option>
        <option name="punchcard_app.punchcard.useColors">false</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row depends="$mode_advanced$,$num_clusters2$">
    <panel>
      <title>Suggested Time Policy for Range and Quantile</title>
      <input type="text" token="num_clusters2">
        <label>Target Number of Time Policies</label>
        <default>5</default>
      </input>
      <table>
        <search base="historical">
          <query>| stats stdev(alert_value) as a_value mean(alert_value) as b_value perc01(alert_value) as c_value perc99(alert_value) as d_value by date_hour date_wday 
| fit KMeans k=$num_clusters2$ "c_value" "d_value"

| eval date_hour=if(date_hour&lt;10,"0".date_hour, date_hour)
| eval date_wday=case(date_wday="monday",1,date_wday="tuesday",2,date_wday="wednesday",3,date_wday="thursday",4,date_wday="friday",5,date_wday="saturday",6,date_wday="sunday",7)."-".date_wday

| sort date_hour, date_wday

| eventstats count as policy_cnt by cluster
| eventstats max(policy_cnt) as max_policy
| eval policy = if(policy_cnt=max_policy, "", cluster)

| sort date_hour, date_wday

| fields - max_policy policy_cnt date policy_num

| chart limit=0 values(policy) over date_wday by date_hour</query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>
